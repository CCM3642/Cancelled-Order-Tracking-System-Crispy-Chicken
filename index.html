<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>نظام إدارة الطلبات الملغاة - CRISPY CHICKEN</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: 'Tahoma', sans-serif; background:#f8f9fa; margin:0; padding:0; direction:rtl; }
    .container { width:95%; max-width:1200px; margin:auto; padding:20px; }
    h1 { text-align:center; color:#333; }
    .form-section,.report-section { background:#fff; padding:20px; margin-bottom:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    label { display:block; margin:10px 0 5px; }
    input,select,button { padding:8px; margin-bottom:10px; width:100%; border:1px solid #ccc; border-radius:5px; }
    button { background:#28a745; color:#fff; cursor:pointer; }
    button:hover { background:#218838; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th,td { border:1px solid #ccc; padding:10px; text-align:center; }
    th { background:#007bff; color:#fff; }
    .dashboard { display:flex; flex-wrap:wrap; gap:15px; margin-top:20px; }
    .card { flex:1; min-width:200px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center; }
    .card h3 { margin:10px 0; color:#333; }
    .filter-group { display:flex; gap:10px; margin:10px 0; }
    .report-stats { display:flex; flex-wrap:wrap; gap:15px; }
    .report-stat { flex:1; min-width:200px; background:#f1f1f1; padding:15px; border-radius:10px; text-align:center; }
    .report-stat .value { font-size:18px; font-weight:bold; }
    .report-stat .label { color:#555; }
    .actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:20px; }
    .notification { position:fixed; bottom:20px; right:20px; background:#28a745; color:#fff; padding:10px 20px; border-radius:5px; display:none; }
  </style>
</head>
<body>
<div class="container">
  <h1>نظام إدارة الطلبات الملغاة - CRISPY CHICKEN</h1>

  <!-- إدخال بيانات -->
  <div class="form-section">
    <h2>إضافة طلب جديد</h2>
    <label>العلامة التجارية</label><input type="text" id="brand">
    <label>القناة</label>
    <select id="channel">
      <option value="Careem">Careem</option>
      <option value="Zomato">Zomato</option>
      <option value="Talabat">Talabat</option>
      <option value="Deliveroo">Deliveroo</option>
    </select>
    <label>الفرع</label><input type="text" id="branch">
    <label>الحالة</label>
    <select id="status">
      <option value="cancelled">ملغى</option>
      <option value="delivered">مُسَلَّم</option>
    </select>
    <label>السعر (درهم)</label><input type="number" id="price" step="0.01">
    <label>عدد الطلبات</label><input type="number" id="count" value="1">
    <button onclick="addOrder()">إضافة الطلب</button>
  </div>

  <!-- لوحة التحكم -->
  <div class="report-section">
    <h2>لوحة التحكم</h2>
    <div class="dashboard">
      <div class="card"><h3 id="totalOrders">0</h3><p>إجمالي الطلبات</p></div>
      <div class="card"><h3 id="cancelledOrders">0</h3><p>الطلبات الملغاة</p></div>
      <div class="card"><h3 id="deliveredOrders">0</h3><p>الطلبات المُسَلَّمَة</p></div>
      <div class="card"><h3 id="cancellationRate">0%</h3><p>نسبة الإلغاء</p></div>
    </div>
  </div>

  <!-- الفلاتر -->
  <div class="filter-group">
    <input type="text" id="filterBranch" placeholder="بحث بالفرع" onkeyup="renderTable()">
    <input type="text" id="filterSearch" placeholder="بحث عام (ماركة / قناة / فرع)" onkeyup="renderTable()">
    <select id="filterChannel" onchange="renderTable()">
      <option value="">جميع القنوات</option>
      <option value="Careem">Careem</option>
      <option value="Zomato">Zomato</option>
      <option value="Talabat">Talabat</option>
      <option value="Deliveroo">Deliveroo</option>
    </select>
    <select id="filterStatus" onchange="renderTable()">
      <option value="">جميع الحالات</option>
      <option value="cancelled">ملغى</option>
      <option value="delivered">مُسَلَّم</option>
    </select>
  </div>

  <!-- الجدول -->
  <div class="report-section">
    <h2>الطلبات</h2>
    <table>
      <thead><tr><th>العلامة</th><th>القناة</th><th>الفرع</th><th>الحالة</th><th>السعر</th><th>العدد</th><th>الإجمالي</th><th>إجراء</th></tr></thead>
      <tbody id="ordersTable"></tbody>
    </table>
  </div>

  <!-- التقارير -->
  <div class="report-section" id="reports">
    <h2>التقارير التفصيلية</h2>
    <div id="channelReport"></div>
    <div id="branchReport"></div>
  </div>

  <!-- أزرار -->
  <div class="actions">
    <button onclick="exportToCSV()">تصدير CSV</button>
    <button onclick="exportToPDF()">تصدير PDF</button>
  </div>
</div>

<div class="notification" id="notification"></div>

<script>
let orders = JSON.parse(localStorage.getItem('orders') || '[]');

function addOrder() {
  const brand = document.getElementById('brand').value.trim();
  const channel = document.getElementById('channel').value;
  const branch = document.getElementById('branch').value.trim();
  const status = document.getElementById('status').value;
  const price = parseFloat(document.getElementById('price').value) || 0;
  const count = parseInt(document.getElementById('count').value) || 1;
  if (!brand || !branch) { alert('أدخل البيانات كاملة'); return; }
  orders.push({ brand, channel, branch, status, price, count, total: price * count });
  localStorage.setItem('orders', JSON.stringify(orders));
  renderTable(); updateDashboard(); generateReports();
  showNotification('تمت إضافة الطلب');
}

function renderTable() {
  const tbody = document.getElementById('ordersTable');
  tbody.innerHTML = '';
  const filterBranch = document.getElementById('filterBranch').value.toLowerCase();
  const filterSearch = document.getElementById('filterSearch').value.toLowerCase();
  const filterChannel = document.getElementById('filterChannel').value;
  const filterStatus = document.getElementById('filterStatus').value;
  const filteredOrders = orders.filter(o => {
    const matchChannel = !filterChannel || o.channel === filterChannel;
    const matchBranch = !filterBranch || o.branch.toLowerCase().includes(filterBranch);
    const matchStatus = !filterStatus || o.status === filterStatus;
    const matchSearch = !filterSearch ||
      o.brand.toLowerCase().includes(filterSearch) ||
      o.channel.toLowerCase().includes(filterSearch) ||
      o.branch.toLowerCase().includes(filterSearch);
    return matchChannel && matchBranch && matchStatus && matchSearch;
  });
  filteredOrders.forEach((o,i) => {
    tbody.innerHTML += `<tr>
      <td>${o.brand}</td><td>${o.channel}</td><td>${o.branch}</td><td>${o.status}</td>
      <td>${o.price.toFixed(2)}</td><td>${o.count}</td><td>${o.total.toFixed(2)}</td>
      <td><button style="background:#dc3545" onclick="deleteOrder(${i})">حذف</button></td>
    </tr>`;
  });
}

function deleteOrder(i) {
  orders.splice(i,1); localStorage.setItem('orders', JSON.stringify(orders));
  renderTable(); updateDashboard(); generateReports();
  showNotification('تم حذف الطلب');
}

function updateDashboard() {
  const total = orders.length;
  const cancelled = orders.filter(o => o.status === 'cancelled').length;
  const delivered = orders.filter(o => o.status === 'delivered').length;
  const rate = total ? ((cancelled/total)*100).toFixed(1)+'%' : '0%';
  document.getElementById('totalOrders').textContent = total;
  document.getElementById('cancelledOrders').textContent = cancelled;
  document.getElementById('deliveredOrders').textContent = delivered;
  document.getElementById('cancellationRate').textContent = rate;
}

function generateReports() {
  document.getElementById('channelReport').innerHTML = '<h3>تقرير القنوات</h3>'+generateChannelReport();
  document.getElementById('branchReport').innerHTML = '<h3>تقرير الفروع</h3>'+generateBranchReport();
}

function generateChannelReport() {
  const channels = [...new Set(orders.map(o=>o.channel))];
  let html='<div class="report-stats">';
  channels.forEach(ch=>{
    const chOrders = orders.filter(o=>o.channel===ch);
    const cancelled = chOrders.filter(o=>o.status==='cancelled').length;
    const delivered = chOrders.filter(o=>o.status==='delivered').length;
    const loss = chOrders.filter(o=>o.status==='cancelled').reduce((s,o)=>s+o.total,0);
    const revenue = chOrders.filter(o=>o.status==='delivered').reduce((s,o)=>s+o.total,0);
    html+=`<div class="report-stat"><div class="value">${ch}</div>
      <div class="label">${cancelled} ملغى / ${delivered} مُسَلَّم</div>
      <div class="label">${loss.toFixed(2)} درهم خسارة</div>
      <div class="label">${revenue.toFixed(2)} درهم إيراد</div></div>`;
  });
  return html+'</div>';
}

function generateBranchReport() {
  const branches=[...new Set(orders.map(o=>o.branch))];
  let html='<div class="report-stats">';
  branches.forEach(br=>{
    const brOrders=orders.filter(o=>o.branch===br);
    const cancelled=brOrders.filter(o=>o.status==='cancelled').length;
    const delivered=brOrders.filter(o=>o.status==='delivered').length;
    const loss=brOrders.filter(o=>o.status==='cancelled').reduce((s,o)=>s+o.total,0);
    const revenue=brOrders.filter(o=>o.status==='delivered').reduce((s,o)=>s+o.total,0);
    html+=`<div class="report-stat"><div class="value">${br}</div>
      <div class="label">${cancelled} ملغى / ${delivered} مُسَلَّم</div>
      <div class="label">${loss.toFixed(2)} درهم خسارة</div>
      <div class="label">${revenue.toFixed(2)} درهم إيراد</div></div>`;
  });
  return html+'</div>';
}

function exportToCSV() {
  let csv='Brand,Channel,Branch,Status,Price,Count,Total\n';
  orders.forEach(o=>{csv+=`${o.brand},${o.channel},${o.branch},${o.status},${o.price},${o.count},${o.total}\n`});
  const blob=new Blob([csv],{type:'text/csv'});
  const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download='orders.csv'; link.click();
  showNotification('تم تصدير CSV');
}

function exportToPDF() {
  const element=document.getElementById('reports');
  const opt={margin:10,filename:`orders_report_${new Date().toISOString().split('T')[0]}.pdf`,
    image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
  html2pdf().set(opt).from(element).save();
  showNotification('تم تصدير PDF');
}

function showNotification(msg) {
  const n=document.getElementById('notification'); n.textContent=msg; n.style.display='block';
  setTimeout(()=>n.style.display='none',3000);
}

renderTable(); updateDashboard(); generateReports();
</script>
</body>
</html>
